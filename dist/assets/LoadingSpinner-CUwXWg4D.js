import{u as p,l as H,r as g,c as v,d as E,a as x,n as P,b as T,e as A,t as D,o as S,_ as I}from"./index-boeohUY1.js";class d extends Error{constructor(t){super(t),this.name="AuthenticationError"}}const N=300;class B{token=null;tokenExpiry=0;async getToken(){return this.isTokenValid()?this.token:this.requestToken()}isTokenValid(){return this.token?Math.floor(Date.now()/1e3)<this.tokenExpiry-N:!1}async requestToken(){const t=p();if(!t.clientId||!t.clientSecret)throw new d("Missing credentials. Please configure your Battle.net Client ID and Secret in Settings.");if(!t.proxyUrl)throw new d("Missing proxy URL. Please configure the Cloudflare Worker URL in Settings.");try{const e=await fetch(`${t.proxyUrl}/api/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:t.clientId,clientSecret:t.clientSecret})});if(!e.ok){const s=await e.json().catch(()=>({}));throw e.status===401?new d("Invalid credentials. Please check your Client ID and Secret."):new d(s.error||`Authentication failed with status ${e.status}`)}const o=await e.json();return this.token=o.access_token,this.tokenExpiry=Math.floor(Date.now()/1e3)+o.expires_in,this.token}catch(e){throw e instanceof d?e:e instanceof TypeError&&e.message.includes("fetch")?new d("Failed to connect to the OAuth proxy. Please check the proxy URL and ensure it's deployed."):new d(`Authentication request failed: ${e instanceof Error?e.message:"Unknown error"}`)}}invalidateToken(){this.token=null,this.tokenExpiry=0}getState(){return{token:this.token,tokenExpiry:this.tokenExpiry,isAuthenticated:this.isTokenValid()}}}const w=new B,C=H("auth",()=>{const c=g(null),t=g(0),e=g(!1),o=g(null),s=g(null),n=v(()=>c.value?Math.floor(Date.now()/1e3)<t.value-300:!1),u=v(()=>{if(!t.value)return 0;const r=Math.floor(Date.now()/1e3);return Math.max(0,t.value-r)});async function a(){e.value=!0,o.value=null;try{const r=await w.getToken(),k=w.getState();return c.value=r,t.value=k.tokenExpiry,s.value=new Date,!0}catch(r){return r instanceof d?o.value=r.message:o.value="An unexpected error occurred during authentication",!1}finally{e.value=!1}}async function i(){return n.value?!0:a()}async function m(){if(!n.value&&!await a())throw new d(o.value||"Authentication failed");return c.value}function h(){w.invalidateToken(),c.value=null,t.value=0,s.value=null,o.value=null}function l(){o.value=null}return{token:c,tokenExpiry:t,isLoading:e,error:o,lastAuthenticated:s,isAuthenticated:n,tokenExpiresIn:u,authenticate:a,refreshToken:i,getValidToken:m,logout:h,clearError:l}});class f extends Error{constructor(t,e){super(t),this.status=e,this.name="APIError"}}class L extends f{constructor(){super(`This profile is private. To make it public:
1. Go to Battle.net Account Settings
2. Navigate to Privacy settings
3. Enable "Diablo III Profile" visibility`),this.name="ProfilePrivateError"}}class R extends f{constructor(){super("Hero not found. Please check the hero ID."),this.name="HeroNotFoundError"}}const b={barbarian:"Barbarian",crusader:"Crusader","demon-hunter":"Demon Hunter",monk:"Monk",necromancer:"Necromancer","witch-doctor":"Witch Doctor",wizard:"Wizard"},U={head:"Head",shoulders:"Shoulders",neck:"Amulet",torso:"Chest",hands:"Gloves",waist:"Belt",wrists:"Bracers",legs:"Pants",feet:"Boots",leftFinger:"Left Ring",rightFinger:"Right Ring",mainHand:"Main Hand",offHand:"Off Hand"};class j{async request(t){const e=p(),o=C(),s=await o.getValidToken(),n=await fetch(`${e.proxyUrl}/api/proxy`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:s,region:e.region,endpoint:t})});if(!n.ok){const u=await n.json().catch(()=>({}));throw n.status===401?(o.logout(),new f("Authentication expired. Please re-authenticate.")):n.status===403?new L:n.status===404?(u?.details?.code||"").toString().toUpperCase().includes("NOTFOUND")?new R:new f(`Resource not found: ${t}`,404):n.status===429?new f("Rate limited. Please try again in a few minutes.",429):new f(u.error||`API request failed with status ${n.status}`,n.status)}return n.json()}formatBattletag(t){return t.replace("#","-")}stripHtml(t){return t?t.replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim():""}async getProfile(){const t=p(),e=this.formatBattletag(t.battletag);return this.request(`/d3/profile/${e}/`)}async getHeroes(){return(await this.getProfile()).heroes.map(e=>({heroId:e.id,name:e.name,heroClass:b[e.class]||e.class,level:e.level,paragonLevel:e.paragonLevel,seasonal:e.seasonal,hardcore:e.hardcore,dead:e.dead,lastUpdated:e["last-updated"],gender:e.gender}))}async getHeroDetails(t){const e=p(),o=this.formatBattletag(e.battletag),s=await this.request(`/d3/profile/${o}/hero/${t}`),n={heroId:s.id,name:s.name,heroClass:b[s.class]||s.class,level:s.level,paragonLevel:s.paragonLevel,seasonal:s.seasonal,hardcore:s.hardcore,dead:s.dead,lastUpdated:s["last-updated"],gender:s.gender,life:s.stats?.life,damage:s.stats?.damage,toughness:s.stats?.toughness,recovery:s.stats?.healing,activeSkills:[],passiveSkills:[],items:{},legendaryGems:[]};for(const a of s.skills?.active||[])a.skill&&n.activeSkills.push({name:a.skill.name,slug:a.skill.slug,description:this.stripHtml(a.skill.description||""),rune:a.rune?.name,runeDescription:this.stripHtml(a.rune?.description||"")});for(const a of s.skills?.passive||[])a.skill&&n.passiveSkills.push({name:a.skill.name,slug:a.skill.slug,description:this.stripHtml(a.skill.description||"")});const u=s.legendaryPowers||[];return u.length>0&&(n.cubePowers={weapon:u[0]?.name,armor:u[1]?.name,jewelry:u[2]?.name}),n}async getHeroItems(t){const e=p(),o=this.formatBattletag(e.battletag),s=await this.request(`/d3/profile/${o}/hero/${t}/items`),n={},u=[];for(const[a,i]of Object.entries(s)){if(!i||typeof i!="object"||!i.name)continue;let m="common";switch(i.displayColor){case"green":m="set";break;case"orange":m="legendary";break;case"yellow":m="rare";break;case"blue":m="magic";break}const h={slot:U[a]||a,name:i.name,itemType:i.typeName||"",quality:m,setName:i.set?.name,armor:i.armor?.max,dps:i.dps?.max,attacksPerSecond:i.attacksPerSecond?.max,primaryStats:[],secondaryStats:[],gems:[],icon:i.icon};for(const l of i.attributes?.primary||[]){const r=this.stripHtml(l.textHtml||l.text||"");r&&h.primaryStats.push(r)}for(const l of i.attributes?.secondary||[]){const r=this.stripHtml(l.textHtml||l.text||"");r&&h.secondaryStats.push(r)}for(const l of i.attributes?.passive||[]){const r=this.stripHtml(l.textHtml||l.text||"");if(r){h.legendaryPower=r;break}}for(const l of i.gems||[]){const r=l.isGem&&l.jewelRank!==void 0,k={name:l.item?.name||"Unknown Gem",rank:l.jewelRank,isLegendary:r,attributes:(l.attributes||[]).map(y=>this.stripHtml(y.textHtml||y.text||""))};h.gems.push(k),r&&u.push(k)}i.transmog&&(h.transmog=i.transmog.name),n[a]=h}return{items:n,legendaryGems:u}}async getFullHero(t){const e=await this.getHeroDetails(t),{items:o,legendaryGems:s}=await this.getHeroItems(t);return e.items=o,e.legendaryGems=s,e}}const q=new j,$={key:0,class:"loading-message"},F=E({__name:"LoadingSpinner",props:{size:{},message:{}},setup(c){return(t,e)=>(S(),x("div",{class:P(["loading-container",c.size||"md"])},[e[0]||(e[0]=T("div",{class:"spinner"},null,-1)),c.message?(S(),x("p",$,D(c.message),1)):A("",!0)],2))}}),M=I(F,[["__scopeId","data-v-4c3fb465"]]);export{f as A,M as L,q as b,C as u};
